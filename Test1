<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HealthBuddy</title>

    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{
          font-family:"Baloo 2",sans-serif;
          background:#fff9e6;
          display:flex;
          justify-content:center;
        }
        .app{width:480px;min-height:100vh;padding:24px;position:relative}
        .logo{text-align:center;margin-bottom:24px}
        .logo-circle{
          width:90px;height:90px;border-radius:50%;
          background:#8ee7c4;margin:0 auto 8px;
          display:flex;align-items:center;justify-content:center
        }
        .logo-inner{width:35px;height:35px;border-radius:50%;background:#0e4c55}

        .admin-link{
          position:absolute;top:10px;right:14px;
          font-size:.8rem;opacity:.6;cursor:pointer;user-select:none
        }

        .screen{display:none}
        .screen.active{display:block}

        .card{
          background:#8ee7c4;padding:18px;border-radius:24px;
          text-align:center;margin-bottom:20px
        }

        .btn{
          width:100%;border:none;border-radius:26px;
          padding:14px;font-size:1.1rem;
          font-weight:700;margin:10px 0;cursor:pointer
        }
        .btn-green{background:#79d873}
        .btn-dark{background:#0e4c55;color:#fff}
        .btn-mint{background:#8ee7c4}
        .btn-red{background:#ff7f7f}

        .camera-box{
          width:100%;height:220px;background:#ccc;
          border-radius:12px;overflow:hidden;margin-bottom:16px;
          display:flex;align-items:center;justify-content:center;
        }
        .camera-box video{width:100%;height:100%;object-fit:cover}
        .camera-fallback{padding:14px;text-align:center;font-weight:700;opacity:.75}

        .mood-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}

        .input{
          width:100%;padding:14px;border-radius:26px;border:none;margin-bottom:12px;
          background:#fff;font-size:1rem
        }

        .small{text-align:center;opacity:.75;margin-top:8px}
        a.link{color:#0e4c55;font-weight:700;text-decoration:underline}

        #timer{font-size:2rem;font-weight:900;text-align:center;margin:10px 0}
        #savedGoal{
          background:#fff;border-radius:16px;padding:12px;margin-top:10px;
          font-weight:700;display:none;text-align:left
        }
        ul{padding-left:20px}
    </style>
</head>

<body>
<div class="app">

    <div class="admin-link" onclick="goAdmin()">I’m admin</div>

    <div class="logo">
        <div class="logo-circle"><div class="logo-inner"></div></div>
        <strong>HEALTHBUDDY</strong>
    </div>

    <!-- HOME -->
    <section id="home" class="screen active">
        <div class="card">
            <h2>Welcome to HealthBuddy</h2>
            <p>Scan a HealthBuddy pole to continue</p>
        </div>
        <button class="btn btn-green" onclick="showScreen('scan')">Scan pole</button>
    </section>

    <!-- SCAN POLE -->
    <section id="scan" class="screen">
        <div class="camera-box">
            <video id="camera" autoplay playsinline></video>
            <div id="cameraFallback" class="camera-fallback" style="display:none;">
                Camera not available or permission denied.
            </div>
        </div>

        <!-- Simuleert "paal gescand" + telt scan voor admin -->
        <button class="btn btn-green" onclick="registerScan()">Pole scanned</button>
        <button class="btn btn-mint" onclick="showScreen('home')">Back</button>

        <p class="small">Camera starts on this screen. The button simulates a successful scan.</p>
    </section>

    <!-- MOOD -->
    <section id="mood" class="screen">
        <div class="card">
            <h2>How do you feel?</h2>
            <p>Press one of the 4 buttons</p>
        </div>

        <div class="mood-grid">
            <button class="btn btn-green" onclick="selectMood('good')">Great!</button>
            <button class="btn btn-mint" onclick="selectMood('ok')">Could be better</button>
            <button class="btn" style="background:#ffc75b" onclick="selectMood('sad')">Sad :(</button>
            <button class="btn btn-red" onclick="selectMood('very-sad')">Very sad :(</button>
        </div>

        <button class="btn btn-mint" onclick="showScreen('scan')">Back</button>
    </section>

    <!-- TIPS (DYNAMIC) -->
    <section id="tips" class="screen">
        <div id="tipsCard" class="card">
            <h2 id="tipsTitle"></h2>
            <p id="tipsSubtitle"></p>
        </div>

        <div id="tipsContent"></div>

        <p class="small" id="safety" style="display:none;">
            If you are in immediate danger, call your local emergency number.
            In the Netherlands you can also contact
            <a class="link" href="https://www.113.nl" target="_blank" rel="noopener">113.nl</a>.
        </p>

        <button class="btn btn-mint" onclick="showScreen('mood')">Back</button>
    </section>

    <!-- ADMIN SETUP (ONE TIME) -->
    <section id="admin-setup" class="screen">
        <div class="card">
            <h2>Admin setup</h2>
            <p>Set your admin code (one time)</p>
        </div>

        <input id="setupCode" class="input" placeholder="New admin code" />
        <button class="btn btn-dark" onclick="saveAdminCode()">Save code</button>
        <button class="btn btn-mint" onclick="showScreen('home')">Back</button>

        <p id="setupError" class="small" style="display:none;color:#b00020;font-weight:700;"></p>
    </section>

    <!-- ADMIN LOGIN -->
    <section id="admin-login" class="screen">
        <div class="card">
            <h2>Admin login</h2>
            <p>Enter admin code</p>
        </div>

        <input id="loginCode" class="input" placeholder="Admin code" />
        <button class="btn btn-dark" onclick="adminLogin()">Login</button>
        <button class="btn btn-mint" onclick="showScreen('home')">Back</button>

        <p id="loginError" class="small" style="display:none;color:#b00020;font-weight:700;"></p>
    </section>

    <!-- ADMIN PANEL -->
    <section id="admin-panel" class="screen">
        <div class="card">
            <h2>Admin panel</h2>
            <p>Usage overview (stored locally in this browser)</p>
        </div>

        <div class="card" style="background:#fff;">
            <p><strong>Total scans:</strong> <span id="adminScans">0</span></p>
            <p><strong>Great:</strong> <span id="adminGood">0</span></p>
            <p><strong>Could be better:</strong> <span id="adminOk">0</span></p>
            <p><strong>Sad:</strong> <span id="adminSad">0</span></p>
            <p><strong>Very sad:</strong> <span id="adminVerySad">0</span></p>
        </div>

        <div class="card" style="background:#fff;">
            <h3 style="text-align:left;margin-bottom:8px;">Last interactions</h3>
            <ul id="adminHistory"></ul>
        </div>

        <button class="btn btn-red" onclick="resetAdminData()">Reset admin data</button>
        <button class="btn btn-dark" onclick="adminLogout()">Logout</button>

        <p class="small">To change the admin code: clear site data in your browser, or use the button below.</p>
        <button class="btn btn-mint" onclick="resetAdminCode()">Reset admin code (danger)</button>
    </section>

</div>

<script>
    /* ===========================
       CAMERA
       =========================== */
    let stream = null;

    async function startCamera() {
      const video = document.getElementById("camera");
      const fallback = document.getElementById("cameraFallback");

      fallback.style.display = "none";
      video.style.display = "block";

      try {
        if (stream) { video.srcObject = stream; return; }

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          video.style.display = "none";
          fallback.style.display = "block";
          fallback.textContent = "Camera API not supported in this browser.";
          return;
        }

        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = stream;
      } catch (e) {
        video.style.display = "none";
        fallback.style.display = "block";
        fallback.textContent = "Camera not available or permission denied.";
        stream = null;
      }
    }

    function stopCamera() {
      const video = document.getElementById("camera");
      if (video) video.srcObject = null;

      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    /* ===========================
       NAVIGATION
       =========================== */
    function showScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      const target = document.getElementById(id);
      if (target) target.classList.add("active");

      // camera lifecycle
      if (id === "scan") startCamera();
      else stopCamera();

      // render screens
      if (id === "tips") renderTips();

      if (id === "admin-panel") {
        if (!isAdminLoggedIn()) { showScreen("admin-login"); return; }
        renderAdminPanel();
      }
    }

    /* ===========================
       ADMIN: SETUP + LOGIN (CODE)
       =========================== */
    const ADMIN_HASH_KEY = "healthbuddy_admin_hash";
    const ADMIN_SESSION_KEY = "healthbuddy_admin_session";

    function isAdminLoggedIn() {
      return localStorage.getItem(ADMIN_SESSION_KEY) === "true";
    }

    function goAdmin() {
      if (!localStorage.getItem(ADMIN_HASH_KEY)) {
        showScreen("admin-setup");
      } else if (isAdminLoggedIn()) {
        showScreen("admin-panel");
      } else {
        showScreen("admin-login");
      }
    }

    async function sha256(text) {
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function saveAdminCode() {
      const code = (document.getElementById("setupCode").value || "").trim();
      const err = document.getElementById("setupError");
      err.style.display = "none";

      if (code.length < 3) {
        err.textContent = "Code too short (min 3 characters).";
        err.style.display = "block";
        return;
      }

      const hashed = await sha256(code);
      localStorage.setItem(ADMIN_HASH_KEY, hashed);
      document.getElementById("setupCode").value = "";
      alert("Admin code saved.");
      showScreen("admin-login");
    }

    async function adminLogin() {
      const code = (document.getElementById("loginCode").value || "").trim();
      const savedHash = localStorage.getItem(ADMIN_HASH_KEY);
      const err = document.getElementById("loginError");
      err.style.display = "none";

      if (!savedHash) {
        showScreen("admin-setup");
        return;
      }

      const inputHash = await sha256(code);

      if (inputHash === savedHash) {
        localStorage.setItem(ADMIN_SESSION_KEY, "true");
        document.getElementById("loginCode").value = "";
        showScreen("admin-panel");
      } else {
        err.textContent = "Wrong code.";
        err.style.display = "block";
      }
    }

    function adminLogout() {
      localStorage.removeItem(ADMIN_SESSION_KEY);
      showScreen("home");
    }

    function resetAdminCode() {
      // Dangerous by design: removes code + session
      localStorage.removeItem(ADMIN_HASH_KEY);
      localStorage.removeItem(ADMIN_SESSION_KEY);
      alert("Admin code removed. You must set a new code.");
      showScreen("admin-setup");
    }

    /* ===========================
       ADMIN STATS
       =========================== */
    const ADMIN_DATA_KEY = "healthbuddy_admin_data";

    function getAdminData() {
      try {
        return JSON.parse(localStorage.getItem(ADMIN_DATA_KEY)) || {
          scans: 0,
          moods: { good: 0, ok: 0, sad: 0, "very-sad": 0 },
          history: []
        };
      } catch {
        return { scans: 0, moods: { good: 0, ok: 0, sad: 0, "very-sad": 0 }, history: [] };
      }
    }

    function saveAdminData(data) {
      localStorage.setItem(ADMIN_DATA_KEY, JSON.stringify(data));
    }

    function resetAdminData() {
      localStorage.removeItem(ADMIN_DATA_KEY);
      alert("Admin data reset.");
      renderAdminPanel();
    }

    function registerScan() {
      const data = getAdminData();
      data.scans++;
      data.history.unshift({ type: "scan", time: new Date().toLocaleString() });
      data.history = data.history.slice(0, 10);
      saveAdminData(data);

      showScreen("mood");
    }

    function renderAdminPanel() {
      const d = getAdminData();
      document.getElementById("adminScans").textContent = d.scans;
      document.getElementById("adminGood").textContent = d.moods.good;
      document.getElementById("adminOk").textContent = d.moods.ok;
      document.getElementById("adminSad").textContent = d.moods.sad;
      document.getElementById("adminVerySad").textContent = d.moods["very-sad"];

      const list = document.getElementById("adminHistory");
      list.innerHTML = (d.history || []).map(h => {
        if (h.type === "scan") return `<li>${h.time} — scan</li>`;
        return `<li>${h.time} — mood: ${h.mood}</li>`;
      }).join("");
    }

    /* ===========================
       MOOD + DYNAMIC TIPS
       =========================== */
    let selectedMood = null;
    let timerInt = null;

    function selectMood(mood) {
      selectedMood = mood;

      const data = getAdminData();
      if (data.moods[mood] !== undefined) data.moods[mood]++;
      data.history.unshift({ type: "mood", mood, time: new Date().toLocaleString() });
      data.history = data.history.slice(0, 10);
      saveAdminData(data);

      showScreen("tips");
    }

    function renderTips() {
      const tipsTitle = document.getElementById("tipsTitle");
      const tipsSubtitle = document.getElementById("tipsSubtitle");
      const tipsContent = document.getElementById("tipsContent");
      const tipsCard = document.getElementById("tipsCard");
      const safety = document.getElementById("safety");

      if (timerInt) { clearInterval(timerInt); timerInt = null; }

      tipsContent.innerHTML = "";
      safety.style.display = "none";

      if (selectedMood === "good") {
        tipsCard.style.background = "#79d873";
        tipsTitle.textContent = "Nice to hear you feel great";
        tipsSubtitle.textContent = "Keep the momentum going";

        tipsContent.innerHTML = `
          <input id="positiveText" class="input" placeholder="Write something positive to share">
          <button class="btn btn-green" onclick="sharePositive()">Share something positive</button>

          <input id="goalInput" class="input" placeholder="Set a small goal (e.g. walk 5 minutes)">
          <button class="btn btn-green" onclick="saveGoal()">Set a small goal</button>

          <div id="savedGoal"></div>
        `;
      } else if (selectedMood === "ok") {
        tipsCard.style.background = "#8ee7c4";
        tipsTitle.textContent = "Could be better";
        tipsSubtitle.textContent = "Try a small step";

        tipsContent.innerHTML = `
          <div id="timer">05:00</div>
          <button class="btn btn-green" onclick="start5MinTimer()">Start 5 minute break</button>
          <button class="btn btn-green" onclick="sendMessage('Hey, can we talk for a minute?')">Send a message to someone</button>
          <p class="small">Keep this tab open while the timer runs.</p>
        `;
      } else if (selectedMood === "sad") {
        tipsCard.style.background = "#ffc75b";
        tipsTitle.textContent = "It’s sad to hear you feel this way";
        tipsSubtitle.textContent = "You don’t have to do it alone";
        safety.style.display = "block";

        tipsContent.innerHTML = `
          <button class="btn btn-green" onclick="sendMessage('Hey, I’m feeling a bit down. Can we talk?')">Message someone you trust</button>
          <button class="btn btn-green" onclick="open113()">Open 113.nl</button>
          <button class="btn btn-green" onclick="call113()">Call 113</button>
        `;
      } else {
        tipsCard.style.background = "#ff7f7f";
        tipsTitle.textContent = "It’s really tough to feel this way";
        tipsSubtitle.textContent = "Please reach out for support right now";
        safety.style.display = "block";

        tipsContent.innerHTML = `
          <button class="btn btn-red" onclick="call113()">Call 113 now</button>
          <button class="btn btn-green" onclick="open113()">Open 113.nl</button>
          <button class="btn btn-green" onclick="sendMessage('I really need support right now. Can you help me?')">Contact someone immediately</button>
        `;
      }
    }

    async function sharePositive() {
      const text = (document.getElementById("positiveText").value || "").trim();
      if (!text) return alert("Please write something positive first.");

      try {
        if (navigator.share) {
          await navigator.share({ text });
        } else if (navigator.clipboard) {
          await navigator.clipboard.writeText(text);
          alert("Copied to clipboard. Paste it anywhere to share.");
        } else {
          alert("Sharing not supported in this browser.");
        }
      } catch {
        // user cancelled share -> ignore
      }
    }

    function saveGoal() {
      const goal = (document.getElementById("goalInput").value || "").trim();
      if (!goal) return alert("Please enter a small goal.");

      const box = document.getElementById("savedGoal");
      box.textContent = "Your goal: " + goal;
      box.style.display = "block";
    }

    function start5MinTimer() {
      let seconds = 300;
      clearInterval(timerInt);

      const timerEl = document.getElementById("timer");
      if (!timerEl) return;

      timerInt = setInterval(() => {
        const mm = String(Math.floor(seconds / 60)).padStart(2, "0");
        const ss = String(seconds % 60).padStart(2, "0");
        timerEl.textContent = `${mm}:${ss}`;

        if (seconds <= 0) {
          clearInterval(timerInt);
          timerInt = null;
          alert("Your 5 minute break is over.");
          return;
        }
        seconds--;
      }, 1000);
    }

    function sendMessage(text) {
      const msg = encodeURIComponent(text || "Hey, can we talk for a minute?");
      window.location.href = `sms:?body=${msg}`;
    }

    function call113() {
      window.location.href = "tel:113";
    }

    function open113() {
      window.open("https://www.113.nl", "_blank", "noopener");
    }
</script>
</body>
</html>
