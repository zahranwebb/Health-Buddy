<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HealthBuddy</title>

    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{
          font-family:"Baloo 2",sans-serif;
          background:#fff9e6;
          display:flex;
          justify-content:center;
        }
        .app{width:480px;min-height:100vh;padding:24px;position:relative}
        .logo{text-align:center;margin-bottom:24px}
        .logo-circle{
          width:90px;height:90px;border-radius:50%;
          background:#8ee7c4;margin:0 auto 8px;
          display:flex;align-items:center;justify-content:center
        }
        .logo-inner{width:35px;height:35px;border-radius:50%;background:#0e4c55}

        .admin-link{
          position:absolute;top:10px;right:14px;
          font-size:.8rem;opacity:.65;cursor:pointer;user-select:none
        }

        .screen{display:none}
        .screen.active{display:block}

        .card{
          background:#8ee7c4;padding:18px;border-radius:24px;
          text-align:center;margin-bottom:20px
        }

        .btn{
          width:100%;border:none;border-radius:26px;
          padding:14px;font-size:1.1rem;
          font-weight:700;margin:10px 0;cursor:pointer
        }
        .btn-green{background:#79d873}
        .btn-mint{background:#8ee7c4}
        .btn-red{background:#ff7f7f}
        .btn-dark{background:#0e4c55;color:#fff}

        .camera-box{
          width:100%;height:220px;background:#ccc;
          border-radius:12px;overflow:hidden;margin-bottom:16px;
          display:flex;align-items:center;justify-content:center;
          position:relative;
        }
        .camera-box video{width:100%;height:100%;object-fit:cover}
        .camera-fallback{padding:14px;text-align:center;font-weight:700;opacity:.75}

        .mood-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}

        .input{
          width:100%;padding:14px;border-radius:26px;border:none;margin-bottom:12px;
          background:#fff;font-size:1rem
        }

        .small{text-align:center;opacity:.75;margin-top:8px}
        a.link{color:#0e4c55;font-weight:700;text-decoration:underline}

        #timer{font-size:2rem;font-weight:900;text-align:center;margin:10px 0}
        #savedGoal{
          background:#fff;border-radius:16px;padding:12px;margin-top:10px;
          font-weight:700;display:none;text-align:left
        }

        .panel{
          background:#fff;border-radius:18px;padding:14px;margin-bottom:12px;
        }
        .panel p{margin:6px 0}
        .row{display:flex;gap:10px}
        .row > *{flex:1}
        .list{
          list-style:none;padding-left:0;margin-top:8px
        }
        .list li{
          padding:10px 10px;
          border-bottom:1px solid #eee;
          font-weight:600;
          font-size:.95rem;
          word-break:break-word;
        }
        .tag{
          display:inline-block;
          padding:2px 10px;
          border-radius:999px;
          background:#f2f2f2;
          margin-right:8px;
          font-weight:800;
          font-size:.85rem;
        }
        .warn{
          background:#fff;
          border:2px dashed #0e4c55;
          border-radius:18px;
          padding:12px;
          margin-bottom:12px;
          font-weight:700;
        }
        canvas{width:100%;height:220px;border-radius:12px;background:#fafafa}
        select{
          width:100%;
          padding:12px 14px;
          border-radius:26px;
          border:2px solid #eee;
          font-size:1rem;
          font-weight:700;
          background:#fff;
        }
    </style>
</head>

<body>
<div class="app">

    <div class="admin-link" onclick="goAdmin()">I’m admin</div>

    <div class="logo">
        <div class="logo-circle"><div class="logo-inner"></div></div>
        <strong>HEALTHBUDDY</strong>
    </div>

    <!-- HOME -->
    <section id="home" class="screen active">
        <div class="card">
            <h2>Welcome to HealthBuddy</h2>
            <p>Scan a HealthBuddy pole to continue</p>
        </div>
        <button class="btn btn-green" onclick="showScreen('scan')">Scan pole</button>
        <p class="small">This prototype stores scan/mood events locally (localStorage).</p>
    </section>

    <!-- SCAN -->
    <section id="scan" class="screen">
        <div class="card">
            <h2>Scan pole</h2>
            <p>Fill the Pole ID (for testing “per paal”)</p>
        </div>

        <input id="poleIdInput" class="input" placeholder="Pole ID (e.g. PAAL-1)" />

        <div class="camera-box">
            <video id="camera" autoplay playsinline></video>
            <div id="cameraFallback" class="camera-fallback" style="display:none;">
                Camera not available or permission denied.
            </div>
        </div>

        <button class="btn btn-green" onclick="registerScan()">Pole scanned</button>
        <button class="btn btn-mint" onclick="showScreen('home')">Back</button>

        <p class="small">Camera starts on this screen. Button simulates a successful pole scan.</p>
    </section>

    <!-- MOOD -->
    <section id="mood" class="screen">
        <div class="card">
            <h2>How do you feel?</h2>
            <p>Press one of the 4 buttons</p>
        </div>

        <div class="mood-grid">
            <button class="btn btn-green" onclick="selectMood('good')">Great!</button>
            <button class="btn btn-mint" onclick="selectMood('ok')">Could be better</button>
            <button class="btn" style="background:#ffc75b" onclick="selectMood('sad')">Sad :(</button>
            <button class="btn btn-red" onclick="selectMood('very-sad')">Very sad :(</button>
        </div>

        <button class="btn btn-mint" onclick="showScreen('scan')">Back</button>
    </section>

    <!-- TIPS -->
    <section id="tips" class="screen">
        <div id="tipsCard" class="card">
            <h2 id="tipsTitle"></h2>
            <p id="tipsSubtitle"></p>
        </div>

        <div id="tipsContent"></div>

        <p class="small" id="safety" style="display:none;">
            If you are in immediate danger, call your local emergency number.
            In the Netherlands you can also contact
            <a class="link" href="https://www.113.nl" target="_blank" rel="noopener">113.nl</a>.
        </p>

        <button class="btn btn-mint" onclick="showScreen('mood')">Back</button>
    </section>

    <!-- ADMIN LOGIN (LOCAL - CREATE + LOGIN) -->
    <section id="admin-login" class="screen">
        <div class="card">
            <h2>Admin login</h2>
            <p>Maak een admin aan (email + wachtwoord) en log daarna in</p>
        </div>

        <div class="warn" id="adminHint">
            Geen admin gevonden. Vul een email + wachtwoord in en klik <strong>Create admin</strong>.
        </div>

        <input id="adminEmail" class="input" placeholder="Admin email (bijv. admin@gmail.com)">
        <input id="adminPassword" class="input" type="password" placeholder="Admin password">

        <button class="btn btn-dark" onclick="adminLogin()">Login</button>
        <button class="btn btn-green" onclick="createAdmin()">Create admin</button>
        <button class="btn btn-mint" onclick="showScreen('home')">Back</button>

        <p id="adminError" class="small" style="display:none;color:#b00020;font-weight:800;"></p>
    </section>

    <!-- ADMIN PANEL -->
    <section id="admin-panel" class="screen">
        <div class="card">
            <h2>Admin panel</h2>
            <p>Grafieken + per paal</p>
        </div>

        <div class="panel">
            <p><strong>Status:</strong> <span id="adminStatus">Not logged in</span></p>
            <p><strong>Loaded events:</strong> <span id="loadedCount">0</span></p>
        </div>

        <div class="panel">
            <p style="margin-bottom:10px;"><strong>Filter per paal</strong></p>
            <select id="poleSelect"></select>
            <p class="small">Selecteer “All poles” of een specifieke paal.</p>
        </div>

        <div class="panel">
            <p><strong>Mood grafiek (4)</strong></p>
            <canvas id="moodChart" width="900" height="450"></canvas>
            <div class="row" style="margin-top:10px;">
                <div class="panel" style="margin:0;">
                    <p><strong>Great:</strong> <span id="statGood">0</span></p>
                    <p><strong>Could be better:</strong> <span id="statOk">0</span></p>
                </div>
                <div class="panel" style="margin:0;">
                    <p><strong>Sad:</strong> <span id="statSad">0</span></p>
                    <p><strong>Very sad:</strong> <span id="statVerySad">0</span></p>
                </div>
            </div>
        </div>

        <div class="panel">
            <p><strong>Scans per paal</strong></p>
            <canvas id="scanChart" width="900" height="450"></canvas>
            <p class="small">Toont top palen op basis van aantal scans (van loaded events).</p>
        </div>

        <div class="panel">
            <p><strong>Last events</strong></p>
            <ul id="eventList" class="list"></ul>
        </div>

        <button class="btn btn-red" onclick="adminLogout()">Logout</button>
        <button class="btn btn-mint" onclick="showScreen('home')">Back to Home</button>
    </section>

</div>

<script>
    // =========================
    // LOCAL STORAGE KEYS
    // =========================
    const EVENTS_KEY = "healthbuddy_events_local_v1";
    const ADMIN_EMAIL_KEY = "healthbuddy_admin_email_v1";
    const ADMIN_PASS_KEY  = "healthbuddy_admin_pass_v1";

    let stream = null;
    let selectedMood = null;
    let timerInt = null;
    let lastPoleId = "PAAL-1";

    let localAdminLoggedIn = false;
    let cachedEvents = [];
    let adminRefreshInt = null;

    // Expose functions
    window.showScreen = showScreen;
    window.registerScan = registerScan;
    window.selectMood = selectMood;
    window.goAdmin = goAdmin;
    window.adminLogin = adminLogin;
    window.createAdmin = createAdmin;
    window.adminLogout = adminLogout;
    window.sharePositive = sharePositive;
    window.saveGoal = saveGoal;
    window.start5MinTimer = start5MinTimer;
    window.sendMessage = sendMessage;
    window.call113 = call113;
    window.open113 = open113;

    document.getElementById("poleIdInput").value = lastPoleId;
    updateAdminHint();

    function showScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      const target = document.getElementById(id);
      if (target) target.classList.add("active");

      if (id === "scan") startCamera();
      else stopCamera();

      if (id === "tips") renderTips();

      if (id === "admin-panel") {
        if (!localAdminLoggedIn) { showScreen("admin-login"); return; }
        startAdminLive();
      } else {
        stopAdminLive();
      }

      if (id === "admin-login") updateAdminHint();
    }

    async function startCamera() {
      const video = document.getElementById("camera");
      const fallback = document.getElementById("cameraFallback");

      fallback.style.display = "none";
      video.style.display = "block";

      try {
        if (stream) { video.srcObject = stream; return; }
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          video.style.display = "none";
          fallback.style.display = "block";
          fallback.textContent = "Camera API not supported in this browser.";
          return;
        }

        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = stream;
      } catch (e) {
        video.style.display = "none";
        fallback.style.display = "block";
        fallback.textContent = "Camera not available or permission denied.";
        stream = null;
      }
    }

    function stopCamera() {
      const video = document.getElementById("camera");
      if (video) video.srcObject = null;

      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    // =========================
    // LOCAL EVENTS
    // =========================
    function loadLocalEvents() {
      try {
        const raw = localStorage.getItem(EVENTS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveLocalEvents(arr) {
      localStorage.setItem(EVENTS_KEY, JSON.stringify(arr));
    }

    async function saveEvent(type, payload = {}) {
      const arr = loadLocalEvents();
      arr.unshift({ type, ...payload, createdAt: Date.now() });
      saveLocalEvents(arr);
    }

    async function registerScan() {
      const poleId = (document.getElementById("poleIdInput").value || "").trim() || "UNKNOWN";
      lastPoleId = poleId;
      await saveEvent("scan", { poleId });
      showScreen("mood");
    }

    async function selectMood(mood) {
      selectedMood = mood;
      const poleId = lastPoleId || "UNKNOWN";
      await saveEvent("mood", { poleId, mood });
      showScreen("tips");
    }

    function renderTips() {
      const tipsTitle = document.getElementById("tipsTitle");
      const tipsSubtitle = document.getElementById("tipsSubtitle");
      const tipsContent = document.getElementById("tipsContent");
      const tipsCard = document.getElementById("tipsCard");
      const safety = document.getElementById("safety");

      if (timerInt) { clearInterval(timerInt); timerInt = null; }

      tipsContent.innerHTML = "";
      safety.style.display = "none";

      if (selectedMood === "good") {
        tipsCard.style.background = "#79d873";
        tipsTitle.textContent = "Nice to hear you feel great";
        tipsSubtitle.textContent = "Keep the momentum going";
        tipsContent.innerHTML = `
          <input id="positiveText" class="input" placeholder="Write something positive to share">
          <button class="btn btn-green" onclick="sharePositive()">Share something positive</button>

          <input id="goalInput" class="input" placeholder="Set a small goal (e.g. walk 5 minutes)">
          <button class="btn btn-green" onclick="saveGoal()">Set a small goal</button>

          <div id="savedGoal"></div>
        `;
      } else if (selectedMood === "ok") {
        tipsCard.style.background = "#8ee7c4";
        tipsTitle.textContent = "Could be better";
        tipsSubtitle.textContent = "Try a small step";
        tipsContent.innerHTML = `
          <div id="timer">05:00</div>
          <button class="btn btn-green" onclick="start5MinTimer()">Start 5 minute break</button>
          <button class="btn btn-green" onclick="sendMessage('Hey, can we talk for a minute?')">Send a message to someone</button>
          <p class="small">Keep this tab open while the timer runs.</p>
        `;
      } else if (selectedMood === "sad") {
        tipsCard.style.background = "#ffc75b";
        tipsTitle.textContent = "It’s sad to hear you feel this way";
        tipsSubtitle.textContent = "You don’t have to do it alone";
        safety.style.display = "block";
        tipsContent.innerHTML = `
          <button class="btn btn-green" onclick="sendMessage('Hey, I’m feeling a bit down. Can we talk?')">Message someone you trust</button>
          <button class="btn btn-green" onclick="open113()">Open 113.nl</button>
          <button class="btn btn-green" onclick="call113()">Call 113</button>
        `;
      } else {
        tipsCard.style.background = "#ff7f7f";
        tipsTitle.textContent = "It’s really tough to feel this way";
        tipsSubtitle.textContent = "Please reach out for support right now";
        safety.style.display = "block";
        tipsContent.innerHTML = `
          <button class="btn btn-red" onclick="call113()">Call 113 now</button>
          <button class="btn btn-green" onclick="open113()">Open 113.nl</button>
          <button class="btn btn-green" onclick="sendMessage('I really need support right now. Can you help me?')">Contact someone immediately</button>
        `;
      }
    }

    async function sharePositive() {
      const text = (document.getElementById("positiveText").value || "").trim();
      if (!text) return alert("Please write something positive first.");

      try {
        if (navigator.share) await navigator.share({ text });
        else if (navigator.clipboard) { await navigator.clipboard.writeText(text); alert("Copied to clipboard."); }
        else alert("Sharing not supported in this browser.");
      } catch {}
    }

    function saveGoal() {
      const goal = (document.getElementById("goalInput").value || "").trim();
      if (!goal) return alert("Please enter a small goal.");
      const box = document.getElementById("savedGoal");
      box.textContent = "Your goal: " + goal;
      box.style.display = "block";
    }

    function start5MinTimer() {
      let seconds = 300;
      clearInterval(timerInt);
      const timerEl = document.getElementById("timer");
      if (!timerEl) return;

      timerInt = setInterval(() => {
        const mm = String(Math.floor(seconds / 60)).padStart(2, "0");
        const ss = String(seconds % 60).padStart(2, "0");
        timerEl.textContent = `${mm}:${ss}`;
        if (seconds <= 0) { clearInterval(timerInt); timerInt = null; alert("Your 5 minute break is over."); return; }
        seconds--;
      }, 1000);
    }

    function sendMessage(text) {
      const msg = encodeURIComponent(text || "Hey, can we talk for a minute?");
      window.location.href = `sms:?body=${msg}`;
    }
    function call113(){ window.location.href = "tel:113"; }
    function open113(){ window.open("https://www.113.nl", "_blank", "noopener"); }

    // =========================
    // LOCAL ADMIN: CREATE + LOGIN
    // =========================
    function goAdmin(){ showScreen("admin-login"); }

    function updateAdminHint() {
      const hint = document.getElementById("adminHint");
      const savedEmail = localStorage.getItem(ADMIN_EMAIL_KEY);
      const savedPass  = localStorage.getItem(ADMIN_PASS_KEY);

      if (savedEmail && savedPass) {
        hint.innerHTML = `Admin bestaat al (<strong>${escapeHtml(savedEmail)}</strong>). Log in of maak opnieuw (Create admin overschrijft).`;
      } else {
        hint.innerHTML = `Geen admin gevonden. Vul een email + wachtwoord in en klik <strong>Create admin</strong>.`;
      }
    }

    function createAdmin() {
      const err = document.getElementById("adminError");
      err.style.display = "none";

      const email = (document.getElementById("adminEmail").value || "").trim();
      const pass  = (document.getElementById("adminPassword").value || "");

      if (!email || !pass) {
        err.textContent = "Vul email en wachtwoord in.";
        err.style.display = "block";
        return;
      }

      if (!email.includes("@") || email.length < 5) {
        err.textContent = "Gebruik een geldig emailadres (bijv. naam@gmail.com).";
        err.style.display = "block";
        return;
      }

      if (pass.length < 4) {
        err.textContent = "Wachtwoord te kort (minimaal 4 tekens).";
        err.style.display = "block";
        return;
      }

      localStorage.setItem(ADMIN_EMAIL_KEY, email);
      localStorage.setItem(ADMIN_PASS_KEY, pass);

      updateAdminHint();
      alert("Admin aangemaakt. Je kunt nu inloggen.");
    }

    async function adminLogin() {
      const err = document.getElementById("adminError");
      err.style.display = "none";

      const email = (document.getElementById("adminEmail").value || "").trim();
      const pass  = (document.getElementById("adminPassword").value || "");

      const savedEmail = localStorage.getItem(ADMIN_EMAIL_KEY);
      const savedPass  = localStorage.getItem(ADMIN_PASS_KEY);

      if (!savedEmail || !savedPass) {
        err.textContent = "Er is nog geen admin aangemaakt. Klik eerst op Create admin.";
        err.style.display = "block";
        return;
      }

      if (email === savedEmail && pass === savedPass) {
        localAdminLoggedIn = true;
        showScreen("admin-panel");
        return;
      }

      err.textContent = "Email of wachtwoord is fout.";
      err.style.display = "block";
    }

    async function adminLogout() {
      localAdminLoggedIn = false;
      stopAdminLive();
      showScreen("home");
    }

    function startAdminLive() {
      document.getElementById("adminStatus").textContent = localAdminLoggedIn ? "Logged in (local)" : "Not logged in";
      renderAdminFromStorage();
      if (adminRefreshInt) clearInterval(adminRefreshInt);
      adminRefreshInt = setInterval(renderAdminFromStorage, 1000);
    }

    function stopAdminLive() {
      if (adminRefreshInt) {
        clearInterval(adminRefreshInt);
        adminRefreshInt = null;
      }
    }

    function renderAdminFromStorage() {
      cachedEvents = loadLocalEvents();
      document.getElementById("loadedCount").textContent = String(cachedEvents.length);

      buildPoleDropdown(cachedEvents);
      renderAdminFromFilter();
      renderEventList(cachedEvents);
    }

    function buildPoleDropdown(items) {
      const select = document.getElementById("poleSelect");
      const current = select.value || "ALL";

      const poles = new Set();
      for (const it of items) if (it.poleId) poles.add(it.poleId);
      const sorted = Array.from(poles).sort((a,b)=>a.localeCompare(b));

      select.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "ALL";
      optAll.textContent = "All poles";
      select.appendChild(optAll);

      for (const p of sorted) {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        select.appendChild(opt);
      }

      select.value = (sorted.includes(current) || current === "ALL") ? current : "ALL";
      select.onchange = () => renderAdminFromFilter();
    }

    function renderAdminFromFilter() {
      const filter = document.getElementById("poleSelect").value || "ALL";
      const filtered = (filter === "ALL") ? cachedEvents : cachedEvents.filter(e => e.poleId === filter);

      const moodCounts = { good:0, ok:0, sad:0, "very-sad":0 };
      const scansPerPole = new Map();

      for (const it of cachedEvents) {
        const pid = it.poleId || "UNKNOWN";
        if (!scansPerPole.has(pid)) scansPerPole.set(pid, 0);
        if (it.type === "scan") scansPerPole.set(pid, scansPerPole.get(pid) + 1);
      }

      for (const it of filtered) {
        if (it.type === "mood" && it.mood && moodCounts[it.mood] !== undefined) {
          moodCounts[it.mood]++;
        }
      }

      document.getElementById("statGood").textContent = String(moodCounts.good);
      document.getElementById("statOk").textContent = String(moodCounts.ok);
      document.getElementById("statSad").textContent = String(moodCounts.sad);
      document.getElementById("statVerySad").textContent = String(moodCounts["very-sad"]);

      drawBarChart(
        document.getElementById("moodChart"),
        ["Great","Could be better","Sad","Very sad"],
        [moodCounts.good, moodCounts.ok, moodCounts.sad, moodCounts["very-sad"]],
        "Moods"
      );

      const top = Array.from(scansPerPole.entries()).sort((a,b)=>b[1]-a[1]).slice(0, 10);

      drawBarChart(
        document.getElementById("scanChart"),
        top.map(x=>x[0]),
        top.map(x=>x[1]),
        "Scans"
      );
    }

    function renderEventList(items) {
      const ul = document.getElementById("eventList");
      ul.innerHTML = items.slice(0, 30).map(it => {
        const type = it.type || "event";
        const pole = it.poleId ? ` pole=${escapeHtml(it.poleId)}` : "";
        const mood = it.mood ? ` mood=${escapeHtml(it.mood)}` : "";
        return `<li><span class="tag">${escapeHtml(type)}</span>${pole}${mood}</li>`;
      }).join("");
    }

    function drawBarChart(canvas, labels, values, yLabel) {
      const ctx = canvas.getContext("2d");
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      const padding = 60;
      const maxVal = Math.max(1, ...values);
      const chartW = w - padding*2;
      const chartH = h - padding*2;
      const barCount = labels.length;
      const gap = Math.max(10, Math.floor(chartW * 0.03));
      const barW = Math.max(18, Math.floor((chartW - gap*(barCount-1)) / barCount));

      ctx.fillStyle = "#0e4c55";
      ctx.font = "20px 'Baloo 2'";
      ctx.fillText(yLabel, 12, 32);

      ctx.strokeStyle = "#d6d6d6";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(padding, h - padding);
      ctx.lineTo(w - padding, h - padding);
      ctx.moveTo(padding, h - padding);
      ctx.lineTo(padding, padding);
      ctx.stroke();

      ctx.fillStyle = "#666";
      ctx.font = "18px 'Baloo 2'";
      const ticks = 4;
      for (let i=0;i<=ticks;i++){
        const v = Math.round((maxVal * i)/ticks);
        const y = h - padding - (chartH * i)/ticks;
        ctx.strokeStyle = "#eeeeee";
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(w - padding, y);
        ctx.stroke();
        ctx.fillText(String(v), 18, y+6);
      }

      for (let i=0;i<barCount;i++){
        const x = padding + i*(barW+gap);
        const barH = (values[i] / maxVal) * chartH;
        const y = h - padding - barH;

        ctx.fillStyle = "#0e4c55";
        ctx.fillRect(x, y, barW, barH);

        ctx.fillStyle = "#0e4c55";
        ctx.font = "20px 'Baloo 2'";
        ctx.fillText(String(values[i]), x + 6, y - 8);

        ctx.fillStyle = "#333";
        ctx.font = "18px 'Baloo 2'";
        const label = labels[i];
        const maxChars = 10;
        const line1 = label.length > maxChars ? label.slice(0, maxChars) : label;
        const line2 = label.length > maxChars ? label.slice(maxChars) : "";
        ctx.fillText(line1, x, h - padding + 22);
        if (line2) ctx.fillText(line2, x, h - padding + 44);
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }
</script>
</body>
</html>
